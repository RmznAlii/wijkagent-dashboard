@page "/database"
@using WijkAgent.Models
@using WijkAgent.Services
@inject ICrimeService CrimeService

@* =====================================================
   PAGINA: Database-overzicht van alle delicten
   Doel:
   - Toont alle delicten in een tabelvorm.
   - Biedt een eenvoudige filter op type delict (Diefstal, Vandalisme, Overlast).
   - Data wordt opgehaald via CrimeService (centrale data-laag).
   ===================================================== *@

<h3>Alle delicten in de database</h3>

@* Filter-sectie: gebruiker kan lijst beperken op type delict *@
<div class="mb-3">
    <label>Filter op type delict:</label>
    <select class="form-control w-25" @bind="SelectedFilterType">
        <option value="">Alles</option>
        <option value="Diefstal">Diefstal</option>
        <option value="Vandalisme">Vandalisme</option>
        <option value="Overlast">Overlast</option>
    </select>
</div>

@* Tabel-sectie: toont aantal delicten + details in tabel *@
@if (crimes == null)
{
    <p>Loading...</p>
}
else
{
    <p>Aantal delicten: @crimes.Count</p>
    <table class="table table-striped">
        <thead>
        <tr>
            <th>ID</th>
            <th>Type</th>
            <th>Omschrijving</th>
            <th>Adres</th>
            <th>Lat / Lng</th>
            <th>Tijd</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var c in crimes)
        {
            <tr>
                <td>@c.Id</td>
                <td>@c.Type</td>
                <td>@c.Description</td>
                <td>@c.Street @c.HouseNumber, @c.Postcode @c.City, @c.Province</td>
                <td>@c.Lat, @c.Lng</td>
                <td>@c.IncidentDateTime.ToString("dd-MM-yyyy HH:mm")</td>
            </tr>
        }
        </tbody>
    </table>
}

@code {
    // ==============================================
    // STATE: DATA UIT DE DATABASE
    // - allCrimes: volledige lijst uit CrimeService
    // - crimes: gefilterde lijst die op het scherm staat
    // ==============================================
    private List<Crime>? crimes;
    private List<Crime>? allCrimes;

    // ==============================================
    // STATE: GEKOZEN FILTERTYPE
    // - SelectedFilterType triggert direct FilterCrimes()
    // ==============================================
    private string selectedFilterType = "";

    /// <summary>
    /// Eigenschap gekoppeld aan de dropdown in de UI.
    /// Bij wijziging wordt automatisch FilterCrimes() aangeroepen
    /// om de tabel te verversen op basis van het gekozen type.
    /// </summary>
    private string SelectedFilterType
    {
        get => selectedFilterType;
        set
        {
            selectedFilterType = value;
            FilterCrimes();
        }
    }

    /// <summary>
    /// Wordt eenmalig aangeroepen bij het laden van de pagina.
    /// Haalt alle delicten op via CrimeService en vult daarna de
    /// zichtbare lijst (crimes) via FilterCrimes().
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        allCrimes = await CrimeService.GetAllAsync();
        FilterCrimes();
    }

    /// <summary>
    /// Past filter toe op allCrimes op basis van selectedFilterType.
    /// - Als geen type gekozen is, toont de pagina alle delicten.
    /// - Anders worden alleen delicten met dat type getoond.
    /// </summary>
    private void FilterCrimes()
    {
        crimes = string.IsNullOrEmpty(selectedFilterType)
            ? allCrimes
            : allCrimes?.Where(c => c.Type == selectedFilterType).ToList();
    }
}
