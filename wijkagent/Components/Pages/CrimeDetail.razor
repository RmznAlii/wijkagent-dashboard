@page "/crime/{Id:int}"

@using WijkAgent.Core.Models
@using WijkAgent.Core.Services
@inject ICrimeService CrimeService
@inject IJSRuntime JS
@inject NavigationManager Nav

<div class="politie-logo-bar d-flex align-items-center mb-3">
    <img src="images/politie.svg" class="header-logo me-2" />
</div>

<h3>Delict bekijken</h3>

@if (crime is null)
{
    <div class="delict-card">
        <h5 class="delict-title">Delict niet gevonden</h5>
        <p class="text-muted mb-0">
            Dit delict bestaat niet (meer) of kon niet opgehaald worden.
        </p>

        <button class="btn btn-secondary mt-3" @onclick="GoBack">
            Terug naar Home
        </button>
    </div>
}
else
{
    <div class="row">
        <div class="col-md-8">
            <div id="crimeDetailMap" style="height:600px; width:100%; border-radius:8px;"></div>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-md-8">
            <div class="delict-card">
                <div class="delict-card-header">
                    <div>
                        <span class="delict-title">Delict #@crime.Id</span>

                        <p class="mb-1 mt-2">
                            <strong>Type delict</strong><br />
                            @crime.Type
                        </p>

                        <p class="mb-1">
                            <strong>Beschrijving</strong><br />
                            @crime.Description
                        </p>

                        <p class="mb-0">
                            <strong>Locatie</strong><br />
                            @crime.Street @crime.HouseNumber,
                            @crime.Postcode @crime.City,
                            @crime.Province
                        </p>

                        <p class="mt-2 mb-0">
                            <small>@crime.IncidentDateTime.ToString("dd-MM-yyyy HH:mm")</small>
                        </p>
                    </div>

                    <div style="display:flex; gap:10px; align-items:center;">
                        <button class="btn btn-secondary" @onclick="GoBack">
                            Terug
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }

    private Crime? crime;
    private bool _mapInitialized = false;

    protected override async Task OnInitializedAsync()
    {
        crime = await CrimeService.GetByIdAsync(Id);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || crime is null || _mapInitialized)
            return;

        _mapInitialized = true;

        await JS.InvokeVoidAsync("initCrimeDetailMap", "crimeDetailMap");
        await JS.InvokeVoidAsync(
            "showSingleCrime",
            crime.Lat,
            crime.Lng,
            crime.Description,
            crime.Type
        );
    }

    private void GoBack()
    {
        Nav.NavigateTo("/");
    }
}
