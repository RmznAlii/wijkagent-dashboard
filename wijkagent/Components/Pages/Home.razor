@page "/"
@inject IJSRuntime JS

<h3>Delictenkaart van Nederland</h3>

<div class="row">
    <div class="col-md-8">
        <div id="crimeMap" style="height:600px; width:100%; border-radius:8px;"></div>
    </div>

    <div class="col-md-4">
        <h5>Nieuw delict toevoegen</h5>

        <div class="mb-2">
            <label>Straat</label>
            <input type="text" class="form-control" @bind="street" @oninput="(_) => ClearLatLng()" />
        </div>
        <div class="mb-2">
            <label>Huisnummer</label>
            <input type="text" class="form-control" @bind="houseNumber" @oninput="(_) => ClearLatLng()" />
        </div>
        <div class="mb-2">
            <label>Postcode</label>
            <input type="text" class="form-control" @bind="postcode" @oninput="(_) => ClearLatLng()" />
        </div>
        <div class="mb-2">
            <label>Stad</label>
            <input type="text" class="form-control" @bind="city" @oninput="(_) => ClearLatLng()" />
        </div>
        <div class="mb-2">
            <label>Provincie</label>
            <input type="text" class="form-control" @bind="province" @oninput="(_) => ClearLatLng()" />
        </div>

        <div class="mb-2">
            <label>Type</label>
            <select class="form-control" @bind="type">
                <option value="">Kies de type misdaad</option>
                <option value="Diefstal">Diefstal</option>
                <option value="Vandalisme">Vandalisme</option>
                <option value="Overlast">Overlast</option>
            </select>
        </div>

        <div class="mb-2">
            <label>Omschrijving</label>
            <input type="text" class="form-control" @bind="description" />
        </div>

        <div class="mt-2">
            <button class="btn btn-outline-primary" @onclick="PlacePin">Zoek adres</button>
            <button class="btn btn-primary ms-2" @onclick="AddCrime">Delict toevoegen</button>
            <button class="btn btn-secondary ms-2" @onclick="ClearCrimes">Alles Verwijderen</button>
        </div>
    </div>
</div>

@code {
    // lat/lng blijven intern bewaard maar niet als invoervelden zichtbaar
    private double lat;
    private double lng;
    private string street = "";
    private string houseNumber = "";
    private string postcode = "";
    private string city = "";
    private string province = "";
    private string type = "";
    private string description = "";

    private DotNetObjectReference<Home>? objRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("initCrimeMap");
            await JS.InvokeVoidAsync("setDotNetHelper", objRef);
        }
    }

    // Wordt aangeroepen door JS wanneer kaart of geocoding een locatie teruggeeft
    [JSInvokable]
    public void MapClicked(double clickedLat, double clickedLng, string clickedPostcode, string clickedCity, string clickedProvince, string clickedStreet, string clickedHouseNumber)
    {
        lat = clickedLat;
        lng = clickedLng;
        postcode = clickedPostcode;
        city = clickedCity;
        province = clickedProvince;
        street = clickedStreet ?? "";
        houseNumber = clickedHouseNumber ?? "";

        StateHasChanged();
    }

    private async Task PlacePin()
    {
        await JS.InvokeVoidAsync("placePinByAddress", street, houseNumber, postcode, city, province);
    }

    private async Task AddCrime()
    {
        if (!string.IsNullOrWhiteSpace(description) && !string.IsNullOrWhiteSpace(type))
        {
            // lat/lng moeten gezet zijn door MapClicked of PlacePin eerder
            if (lat == 0 && lng == 0)
            {
                return;
            }

            string info = $"{type}, {description} ({street} {houseNumber}, {postcode}, {city}, {province})";
            await JS.InvokeVoidAsync("addCrime", lat, lng, info, type);
            description = "";
            type = "";
        }
    }

    private async Task ClearCrimes()
    {
        await JS.InvokeVoidAsync("clearCrimes");
    }

    private void ClearLatLng()
    {
        // When the user edits address fields, discard previously clicked/geocoded coordinates.
        lat = 0;
        lng = 0;
    }

    public void Dispose()
    {
        objRef?.Dispose();
    }
}