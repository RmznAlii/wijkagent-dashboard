@page "/"
@using WijkAgent.Models
@using WijkAgent.Services
@inject IJSRuntime JS
@inject ICrimeService CrimeService

@implements IDisposable

@*
    Home Page – Delictenkaart
    -------------------------
    - Toont een Leaflet-kaart (JS in wwwroot) met alle delicten.
    - Formulier rechts om een nieuw delict toe te voegen.
    - Onder de kaart staat de CrimeList-component met alle delicten.
    - Data komt altijd uit CrimeService (centrale data-laag).
*@


<h3>Delictenkaart van Nederland</h3>

<div class="row">
    <div class="col-md-8">
        <div id="crimeMap" style="height:600px; width:100%; border-radius:8px;"></div>
    </div>

    <div class="col-md-4">
        <h5>Nieuw delict toevoegen</h5>

        <div class="mb-2">
            <label>Straat</label>
            <input type="text" class="form-control" @bind="street" @oninput="(_) => ClearLatLng()" />
        </div>
        <div class="mb-2">
            <label>Huisnummer</label>
            <input type="text" class="form-control" @bind="houseNumber" @oninput="(_) => ClearLatLng()" />
        </div>
        <div class="mb-2">
            <label>Postcode</label>
            <input type="text" class="form-control" @bind="postcode" @oninput="(_) => ClearLatLng()" />
        </div>
        <div class="mb-2">
            <label>Stad</label>
            <input type="text" class="form-control" @bind="city" @oninput="(_) => ClearLatLng()" />
        </div>
        <div class="mb-2">
            <label>Provincie</label>
            <input type="text" class="form-control" @bind="province" @oninput="(_) => ClearLatLng()" />
        </div>

        <div class="mb-2">
            <label>Datum en tijd</label>
            <input type="datetime-local" class="form-control" @bind="incidentDateTime" />
        </div>

        <div class="mb-2">
            <label>Type</label>
            <select class="form-control" @bind="type">
                <option value="">Kies de type misdaad</option>
                <option value="Diefstal">Diefstal</option>
                <option value="Vandalisme">Vandalisme</option>
                <option value="Overlast">Overlast</option>
            </select>
        </div>

        <div class="mb-2">
            <label>Omschrijving</label>
            <input type="text" class="form-control" @bind="description" />
        </div>

        <div class="mt-2">
            <button class="btn btn-outline-primary" @onclick="PlacePin">Zoek adres</button>
            <button class="btn btn-primary ms-2" @onclick="AddCrime">Delict toevoegen</button>
            <button class="btn btn-secondary ms-2" @onclick="ClearCrimes">Alles verwijderen</button>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <h5>Overzicht van delicten</h5>
        <CrimeList Crimes="@crimes" />
    </div>
</div>

@code {
    // Data
    private List<CrimeModel> crimes = new();

    // Laatst gekozen / gegeocodeerde coördinaten voor het formulier
    private double lat;
    private double lng;

    private string street = "";
    private string houseNumber = "";
    private string postcode = "";
    private string city = "";
    private string province = "";
    private string type = "";
    private string description = "";
    private DateTime incidentDateTime = DateTime.Now;

    // JS interop
    private DotNetObjectReference<Home>? objRef;
    private bool _mapInitialized = false;
    private bool _needsMarkerRefresh = false;

    // 1) Elke keer als je naar "/" navigeert (ook na bewerken)
    protected override async Task OnParametersSetAsync()
    {
        // Altijd nieuwste data uit service halen
        crimes = await CrimeService.GetAllAsync();

        // Geef aan dat markers opnieuw getekend moeten worden
        _needsMarkerRefresh = true;
    }

    // 2) Lifecycle: kaart één keer initialiseren, en daarna markers tekenen als nodig
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);

            await JS.InvokeVoidAsync("initCrimeMap");
            await JS.InvokeVoidAsync("setDotNetHelper", objRef);

            _mapInitialized = true;
        }

        if (_mapInitialized && _needsMarkerRefresh)
        {
            _needsMarkerRefresh = false;
            await RedrawMarkersAsync();
        }
    }

    // 3) Helpers: markers wissen en opnieuw tekenen
    private async Task RedrawMarkersAsync()
    {
        await JS.InvokeVoidAsync("clearCrimes");

        foreach (var crime in crimes)
        {
            string info =
                $"{crime.Type}, {crime.Description} — {crime.DateTimeString} <br/> ({crime.Address})";

            await JS.InvokeVoidAsync("addCrime", crime.Lat, crime.Lng, info, crime.Type);
        }
    }

    // Wordt vanuit JS aangeroepen bij klik / geocoding
    [JSInvokable]
    public void MapClicked(double clickedLat, double clickedLng,
        string clickedPostcode, string clickedCity, string clickedProvince,
        string clickedStreet, string clickedHouseNumber)
    {
        lat = clickedLat;
        lng = clickedLng;
        postcode = clickedPostcode;
        city = clickedCity;
        province = clickedProvince;
        street = clickedStreet ?? "";
        houseNumber = clickedHouseNumber ?? "";

        StateHasChanged();
    }

    private async Task PlacePin()
    {
        await JS.InvokeVoidAsync("placePinByAddress", street, houseNumber, postcode, city, province);
    }

    private async Task AddCrime()
    {
        if (string.IsNullOrWhiteSpace(description) || string.IsNullOrWhiteSpace(type))
            return;

        if (lat == 0 && lng == 0)
            return;

        var dt = incidentDateTime.ToString("dd-MM-yyyy HH:mm");

        var newCrime = new CrimeModel
        {
            Type = type,
            Description = description,
            Address = $"{street} {houseNumber}, {postcode} {city}, {province}",
            DateTimeString = dt,
            Lat = lat,
            Lng = lng
        };

        await CrimeService.AddAsync(newCrime);

        // Data opnieuw laden + markers verversen
        crimes = await CrimeService.GetAllAsync();
        _needsMarkerRefresh = true;
        StateHasChanged();

        description = "";
        type = "";
        incidentDateTime = DateTime.Now;
    }

    private async Task ClearCrimes()
    {
        await CrimeService.ClearAsync();
        crimes.Clear();

        _needsMarkerRefresh = true;
        StateHasChanged();
    }

    private void ClearLatLng()
    {
        lat = 0;
        lng = 0;
    }

    public void Dispose()
    {
        objRef?.Dispose();
    }
}
