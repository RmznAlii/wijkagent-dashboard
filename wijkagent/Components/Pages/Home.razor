@page "/"
@using Microsoft.EntityFrameworkCore
@using WijkAgent.Models
@using WijkAgent.Data
@inject WijkAgentDbContext Db
@inject IJSRuntime JS

<div class="navbar d-flex align-items-center mb-3">
    <img src="images/politie.svg" class="header-logo me-2" style="height:50px;" />
</div>

<h3>Delictenkaart van Nederland</h3>

<div class="row">
    <div class="col-md-8">
        <div id="crimeMap" style="height:600px; width:100%; border-radius:8px;"></div>
    </div>

    <div class="col-md-4">
        <h5>Nieuw delict toevoegen</h5>

        <div class="mb-2"><label>Straat</label><input class="form-control" @bind="street"/></div>
        <div class="mb-2"><label>Huisnummer</label><input class="form-control" @bind="houseNumber"/></div>
        <div class="mb-2"><label>Postcode</label><input class="form-control" @bind="postcode"/></div>
        <div class="mb-2"><label>Stad</label><input class="form-control" @bind="city"/></div>
        <div class="mb-2"><label>Provincie</label><input class="form-control" @bind="province"/></div>
        <div class="mb-2"><label>Datum en tijd</label><input type="datetime-local" class="form-control" @bind="incidentDateTime"/></div>
        <div class="mb-2">
            <label>Type</label>
            <select class="form-control" @bind="type">
                <option value="">Kies type misdaad</option>
                <option value="Diefstal">Diefstal</option>
                <option value="Vandalisme">Vandalisme</option>
                <option value="Overlast">Overlast</option>
            </select>
        </div>
        <div class="mb-2"><label>Omschrijving</label><input class="form-control" @bind="description"/></div>

        <div class="mt-2">
            <button class="btn btn-outline-primary" @onclick="PlacePin">Zoek adres</button>
            <button class="btn btn-primary ms-2" @onclick="AddCrime">Delict toevoegen</button>
        </div>
    </div>
</div>

<hr/>

<div class="mt-4">
    <button class="btn btn-secondary" @onclick="ToggleCrimeList">
        @((showCrimeList ? "Sluit delicten" : "Delicten bekijken"))
    </button>

    @if (showCrimeList)
    {
        <div class="mt-3">
            <div class="mb-3">
                <label>Filter op type delict:</label>
                <select class="form-control w-50" @bind="SelectedFilterType">
                    <option value="">Alles</option>
                    <option value="Diefstal">Diefstal</option>
                    <option value="Vandalisme">Vandalisme</option>
                    <option value="Overlast">Overlast</option>
                </select>
            </div>

            @if (crimes == null)
            {
                <p>Loading...</p>
            }
            else if (!crimes.Any())
            {
                <p>Geen delicten gevonden.</p>
            }
            else
            {
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Omschrijving</th>
                        <th>Adres</th>
                        <th>Lat / Lng</th>
                        <th>Tijd</th>
                        <th>Acties</th>
                    </tr>
                    </thead>
                    <tbody>
                    @foreach (var c in crimes)
                    {
                        <tr>
                            <td>@c.Id</td>
                            <td><input class="form-control" @bind="c.Type"/></td>
                            <td><input class="form-control" @bind="c.Description"/></td>
                            <td>@c.Street @c.HouseNumber, @c.Postcode @c.City, @c.Province</td>
                            <td>@c.Lat, @c.Lng</td>
                            <td>@c.IncidentDateTime.ToString("dd-MM-yyyy HH:mm")</td>
                            <td>
                                <button class="btn btn-sm btn-success me-1" @onclick="() => UpdateCrime(c)">Opslaan</button>
                                <button class="btn btn-sm btn-danger" @onclick="() => DeleteCrime(c)">Verwijderen</button>
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            }
        </div>
    }
</div>

@code {
    private string street = "", houseNumber = "", postcode = "", city = "", province = "", type = "", description = "";
    private double lat, lng;
    private DateTime incidentDateTime = DateTime.Now;

    private DotNetObjectReference<Home>? objRef;

    private List<Crime>? crimes;
    private List<Crime>? allCrimes;
    private bool showCrimeList = false;
    private string selectedFilterType = "";

    private string SelectedFilterType
    {
        get => selectedFilterType;
        set
        {
            selectedFilterType = value;
            FilterCrimes();
        }
    }

    protected override async Task OnInitializedAsync() => await LoadCrimes();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (objRef == null)
            objRef = DotNetObjectReference.Create(this);

        await JS.InvokeVoidAsync("initCrimeMap");
        await JS.InvokeVoidAsync("setDotNetHelper", objRef);

        if (allCrimes != null)
        {
            var crimesJson = System.Text.Json.JsonSerializer.Serialize(allCrimes);
            await JS.InvokeVoidAsync("showCrimesFiltered", crimesJson);
        }
    }

    private async Task LoadCrimes()
    {
        allCrimes = await Db.Crimes.OrderByDescending(c => c.CreatedAt).ToListAsync();
        FilterCrimes();
    }

    private void FilterCrimes()
    {
        crimes = string.IsNullOrEmpty(selectedFilterType)
            ? allCrimes
            : allCrimes?.Where(c => c.Type == selectedFilterType).ToList();

        var crimesJson = System.Text.Json.JsonSerializer.Serialize(crimes);
        _ = JS.InvokeVoidAsync("showCrimesFiltered", crimesJson);
    }

    [JSInvokable]
    public void MapClicked(double clickedLat, double clickedLng, string clickedPostcode, string clickedCity, string clickedProvince, string clickedStreet, string clickedHouseNumber)
    {
        lat = clickedLat;
        lng = clickedLng;
        postcode = clickedPostcode;
        city = clickedCity;
        province = clickedProvince;
        street = clickedStreet ?? "";
        houseNumber = clickedHouseNumber ?? "";
        StateHasChanged();
    }

    private async Task PlacePin() => await JS.InvokeVoidAsync("placePinByAddress", street, houseNumber, postcode, city, province, type);

    private async Task AddCrime()
    {
        if (string.IsNullOrWhiteSpace(type) || string.IsNullOrWhiteSpace(description)) return;
        if (lat == 0 && lng == 0) { await JS.InvokeVoidAsync("alert", "Klik eerst op de kaart of zoek een adres."); return; }

        var crime = new Crime
        {
            Type = type,
            Description = description,
            Street = street,
            HouseNumber = houseNumber,
            Postcode = postcode,
            City = city,
            Province = province,
            Lat = lat,
            Lng = lng,
            IncidentDateTime = incidentDateTime,
            CreatedAt = DateTime.Now
        };

        Db.Crimes.Add(crime);
        await Db.SaveChangesAsync();

        await JS.InvokeVoidAsync("addCrime", crime.Lat, crime.Lng, crime.Description, crime.Type);

        // Reset form
        type = description = street = houseNumber = postcode = city = province = "";
        lat = lng = 0;
        incidentDateTime = DateTime.Now;

        await LoadCrimes();
        await JS.InvokeVoidAsync("alert", "Delict toegevoegd!");
    }

    private async Task UpdateCrime(Crime crime) { Db.Crimes.Update(crime); await Db.SaveChangesAsync(); FilterCrimes(); }

    private async Task DeleteCrime(Crime crime) { Db.Crimes.Remove(crime); await Db.SaveChangesAsync(); await LoadCrimes(); }

    private void ToggleCrimeList() => showCrimeList = !showCrimeList;
}
