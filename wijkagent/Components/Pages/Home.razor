@page "/"
@inject IJSRuntime JS

<h3>Delictenkaart van Nederland</h3>

<div class="row">
    <div class="col-md-8">
        <div id="crimeMap" style="height:600px; width:100%; border-radius:8px;"></div>
    </div>

    <div class="col-md-4">
        <h5>Nieuw delict toevoegen</h5>

        <div class="mb-2">
            <label>Latitude</label>
            <input type="number" step="0.0001" class="form-control" @bind="lat" />
        </div>
        <div class="mb-2">
            <label>Longitude</label>
            <input type="number" step="0.0001" class="form-control" @bind="lng" />
        </div>
        <div class="mb-2">
            <label>Postcode</label>
            <input type="text" class="form-control" @bind="postcode" />
        </div>
        <div class="mb-2">
            <label>Stad</label>
            <input type="text" class="form-control" @bind="city" />
        </div>
        <div class="mb-2">
            <label>Provincie</label>
            <input type="" class="form-control" @bind="province" />
        </div>

        <div class="mb-2">
            <label>Type</label>
            <select type="" class="form-control" @bind="type">
                <option value="">Kies de type misdaad</option>
                <option value="Diefstal">Diefstal</option>
                <option value="Vandalisme">Vandalisme</option>
                <option value="Overlast">Overlast</option>
            </select>
        </div>

        <div class="mb-2">
            <label>Omschrijving</label>
            <input type="text" class="form-control" @bind="description" />
        </div>

        <button class="btn btn-primary mt-2" @onclick="AddCrime">Toevoegen</button>
        <button class="btn btn-secondary mt-2 ms-2" @onclick="ClearCrimes">Alles Verwijderen</button>
    </div>
</div>

@code {
    private double lat;
    private double lng;
    private string postcode = "";
    private string city = "";
    private string province = "";
    private string type = "";
    private string description = "";

    private DotNetObjectReference<Home>? objRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("initCrimeMap");
            await JS.InvokeVoidAsync("setDotNetHelper", objRef);
        }
    }

    [JSInvokable]
    public void MapClicked(double clickedLat, double clickedLng, string clickedPostcode, string clickedCity, string clickedProvince)
    {
        lat = clickedLat;
        lng = clickedLng;
        postcode = clickedPostcode;
        city = clickedCity;
        province = clickedProvince;

        StateHasChanged(); // update inputvelden
    }

    private async Task AddCrime()
    {
        if (!string.IsNullOrWhiteSpace(description) && !string.IsNullOrWhiteSpace(type))
        {
            string info = $"{type}, {description} ({postcode}, {city}, {province})";
            await JS.InvokeVoidAsync("addCrime", lat, lng, info, type);
            description = "";
            type = "";
        }
    }

    private async Task ClearCrimes()
    {
        await JS.InvokeVoidAsync("clearCrimes");
    }

    public void Dispose()
    {
        objRef?.Dispose();
    }
}