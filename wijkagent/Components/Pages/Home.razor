@page "/"
@using WijkAgent.Models
@using WijkAgent.Services
@inject IJSRuntime JS
@inject ICrimeService CrimeService

@implements IDisposable

@*
    Home Page – Delictenkaart
    -------------------------
    - Toont een Leaflet-kaart (JS in wwwroot) met alle delicten.
    - Formulier rechts om een nieuw delict toe te voegen.
    - Onder de kaart staat de CrimeList-component met alle delicten.
    - Data komt altijd uit CrimeService (centrale data-laag).
*@

<h3>Delictenkaart van Nederland</h3>

<div class="row">
    <div class="col-md-8">
        @* Container waar de JS-map (Leaflet) in wordt gerenderd *@
        <div id="crimeMap" style="height:600px; width:100%; border-radius:8px;"></div>
    </div>

    <div class="col-md-4">
        <h5>Nieuw delict toevoegen</h5>

        @* 
            Adresvelden.
            Bij elke wijziging in een adresveld wordt ClearLatLng() aangeroepen,
            zodat oude coördinaten ongeldig worden (geforceerd opnieuw zoeken).
        *@
        <div class="mb-2">
            <label>Straat</label>
            <input type="text" class="form-control" @bind="street" @oninput="(_) => ClearLatLng()" />
        </div>
        <div class="mb-2">
            <label>Huisnummer</label>
            <input type="text" class="form-control" @bind="houseNumber" @oninput="(_) => ClearLatLng()" />
        </div>
        <div class="mb-2">
            <label>Postcode</label>
            <input type="text" class="form-control" @bind="postcode" @oninput="(_) => ClearLatLng()" />
        </div>
        <div class="mb-2">
            <label>Stad</label>
            <input type="text" class="form-control" @bind="city" @oninput="(_) => ClearLatLng()" />
        </div>
        <div class="mb-2">
            <label>Provincie</label>
            <input type="text" class="form-control" @bind="province" @oninput="(_) => ClearLatLng()" />
        </div>

        <div class="mb-2">
            <label>Datum en tijd</label>
            <input type="datetime-local" class="form-control" @bind="incidentDateTime" />
        </div>

        <div class="mb-2">
            <label>Type</label>
            <select class="form-control" @bind="type">
                <option value="">Kies de type misdaad</option>
                <option value="Diefstal">Diefstal</option>
                <option value="Vandalisme">Vandalisme</option>
                <option value="Overlast">Overlast</option>
            </select>
        </div>

        <div class="mb-2">
            <label>Omschrijving</label>
            <input type="text" class="form-control" @bind="description" />
        </div>

        <div class="mt-2">
            @* Roept JS aan om coördinaten te zoeken op basis van adres *@
            <button class="btn btn-outline-primary" @onclick="PlacePin">Zoek adres</button>

            @* Voegt een nieuw delict toe (service + kaart + lijst) *@
            <button class="btn btn-primary ms-2" @onclick="AddCrime">Delict toevoegen</button>

            @* Verwijdert alle delicten (service + kaart + lijst) *@
            <button class="btn btn-secondary ms-2" @onclick="ClearCrimes">Alles verwijderen</button>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <h5>Overzicht van delicten</h5>
        @* Herbruikbaar component met bewerken/verwijderen-knoppen *@
        <CrimeList Crimes="@crimes" />
    </div>
</div>

@code {
    // Lokale lijst van delicten voor de UI (bron = CrimeService)
    private List<CrimeModel> crimes = new();

    // Laatst gekozen of gegeocodeerde coördinaten
    private double lat;
    private double lng;

    // Formuliervelden voor het nieuwe delict
    private string street = "";
    private string houseNumber = "";
    private string postcode = "";
    private string city = "";
    private string province = "";
    private string type = "";
    private string description = "";
    private DateTime incidentDateTime = DateTime.Now;

    // Nodig voor JS interop: C#-object dat vanuit JS aangeroepen kan worden
    private DotNetObjectReference<Home>? objRef;

    /// <summary>
    /// Lifecycle-methode van Blazor.
    /// Wordt aangeroepen nadat de component is gerenderd.
    /// </summary>
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        // 1) DotNet helper registreren zodat JS C# kan aanroepen (MapClicked).
        objRef = DotNetObjectReference.Create(this);

        // 2) Kaart initialiseren in JS (Leaflet) en helper instellen.
        await JS.InvokeVoidAsync("initCrimeMap");
        await JS.InvokeVoidAsync("setDotNetHelper", objRef);

        // 3) Bestaande delicten uit de service laden...
        crimes = await CrimeService.GetAllAsync();

        // ...en voor elk delict een marker op de kaart tekenen.
        foreach (var crime in crimes)
        {
            string info =
                $"{crime.Type}, {crime.Description} — {crime.DateTimeString} <br/> ({crime.Address})";

            await JS.InvokeVoidAsync("addCrime", crime.Lat, crime.Lng, info, crime.Type);
        }

        StateHasChanged();
    }

    /// <summary>
    /// Wordt vanuit JavaScript aangeroepen.
    /// JS geeft de coördinaten + adresgegevens door als de gebruiker
    /// op de kaart klikt of als geocoding is voltooid.
    /// </summary>
    [JSInvokable]
    public void MapClicked(double clickedLat, double clickedLng,
        string clickedPostcode, string clickedCity, string clickedProvince,
        string clickedStreet, string clickedHouseNumber)
    {
        lat = clickedLat;
        lng = clickedLng;
        postcode = clickedPostcode;
        city = clickedCity;
        province = clickedProvince;
        street = clickedStreet ?? "";
        houseNumber = clickedHouseNumber ?? "";

        StateHasChanged();
    }

    /// <summary>
    /// Vraagt in JS om op basis van adres een pin te plaatsen
    /// (geocoding gebeurt in de JS-laag).
    /// </summary>
    private async Task PlacePin()
    {
        await JS.InvokeVoidAsync("placePinByAddress", street, houseNumber, postcode, city, province);
    }

    /// <summary>
    /// Maakt een nieuw delict aan op basis van formulier + coördinaten.
    /// Slaat het op in CrimeService, update de UI-lijst en tekent een marker op de kaart.
    /// </summary>
    private async Task AddCrime()
    {
        // Minimale validatie: type en omschrijving verplicht.
        if (string.IsNullOrWhiteSpace(description) || string.IsNullOrWhiteSpace(type))
            return;

        // We eisen dat er coördinaten zijn (geklikt op kaart of gegeocodeerd).
        if (lat == 0 && lng == 0)
            return;

        var dt = incidentDateTime.ToString("dd-MM-yyyy HH:mm");

        var newCrime = new CrimeModel
        {
            Type = type,
            Description = description,
            Address = $"{street} {houseNumber}, {postcode} {city}, {province}",
            DateTimeString = dt,
            Lat = lat,
            Lng = lng
        };

        // 1) Opslaan in de centrale service (bron van waarheid).
        await CrimeService.AddAsync(newCrime);

        // 2) Lijst opnieuw ophalen zodat UI synchroon is met de service.
        crimes = await CrimeService.GetAllAsync();

        // 3) Marker op de kaart tekenen voor het nieuwe delict.
        string info =
            $"{newCrime.Type}, {newCrime.Description} — {newCrime.DateTimeString} <br/> ({newCrime.Address})";

        await JS.InvokeVoidAsync("addCrime", newCrime.Lat, newCrime.Lng, info, newCrime.Type);

        // 4) Formulier resetten voor de volgende invoer.
        description = "";
        type = "";
        incidentDateTime = DateTime.Now;

        StateHasChanged();
    }

    /// <summary>
    /// Verwijdert alle delicten:
    /// - uit CrimeService (data)
    /// - uit de lokale lijst (UI)
    /// - van de kaart (JS markers)
    /// </summary>
    private async Task ClearCrimes()
    {
        await CrimeService.ClearAsync();   // data laag leeg
        crimes.Clear();                    // UI-lijst leeg
        await JS.InvokeVoidAsync("clearCrimes"); // kaart markers leeg

        StateHasChanged();
    }

    /// <summary>
    /// Als het adres wordt aangepast, zijn oude coördinaten niet meer geldig.
    /// Daarom resetten we lat/lng zodat de gebruiker opnieuw een adres/kaartactie moet doen.
    /// </summary>
    private void ClearLatLng()
    {
        lat = 0;
        lng = 0;
    }

    /// <summary>
    /// Opruimen van resources.
    /// Nodig omdat we DotNetObjectReference gebruiken voor JS interop.
    /// </summary>
    public void Dispose()
    {
        objRef?.Dispose();
    }
}
